name: Update Formulas
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      formula:
        description: 'Specific formula to update (optional, e.g., "cook-docs")'
        required: false
        default: ''

jobs:
  update-formulas:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Update Formulas using Gemini CLI
        uses: google-github-actions/run-gemini-cli@v0
        with:
          instructions: |
            You are an automated Homebrew formula updater. Your goal is to keep formulas in the 'Formula/' directory up-to-date with their upstream GitHub releases.

            ${{ github.event.inputs.formula != '' && format('FOCUS: Only update the formula "{0}.rb".', github.event.inputs.formula) || 'SCOPE: Scan and update all formulas in the "Formula/" directory.' }}

            1.  **Scan and Parse**: Identify the target formula(s). Read the `.rb` file(s) and identify the upstream GitHub repository from the `homepage` or `url` field.
            2.  **Check for Updates**: For each formula, use the GitHub CLI (`gh release view --json tagName,assets`) or the GitHub API to find the latest stable release.
            3.  **Compare Versions**: Compare the latest `tagName` (removing any 'v' prefix) with the `version` field in the formula. Proceed only if a newer version is available.
            4.  **Update Assets**:
                a.  Identify the required assets for each platform and architecture (macOS/Linux, ARM/Intel).
                b.  Download these assets and calculate their SHA256 checksums using `sha256sum`.
                c.  Update the `version` string at the top of the formula class.
                d.  Update the `url` and `sha256` strings within the `on_macos` and `on_linux` blocks, ensuring they match the correct hardware architecture (ARM vs Intel).
                e.  If the installation path includes the version number (e.g., `bin.install "proxmox-mcp-rs-0.3.29-..."`), ensure those strings are also updated to the new version.
            5.  **Maintain Integrity**: Ensure the Ruby syntax remains perfectly valid. Mimic the existing indentation and quote style.
            6.  **Verify**: If possible, run `brew audit --strict <formula>` locally to ensure the updated formula is valid.
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add Formula/*.rb
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: auto-update formulas to latest releases"
            git push
          fi
